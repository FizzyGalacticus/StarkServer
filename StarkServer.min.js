"use strict";function _asyncToGenerator(e){return function(){var r=e.apply(this,arguments);return new Promise(function(e,t){function i(n,o){try{var s=r[n](o),a=s.value}catch(e){return void t(e)}if(!s.done)return Promise.resolve(a).then(function(e){i("next",e)},function(e){i("throw",e)});e(a)}return i("next")})}}function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,r){for(var t=0;t<r.length;t++){var i=r[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(r,t,i){return t&&e(r.prototype,t),i&&e(r,i),r}}(),Domain=function(){function e(r,t){_classCallCheck(this,e),r&&t?(this.hosts=r,this.baseDirectory=t):console.error("Both hosts and baseDirectory must be set for Domain object!")}return _createClass(e,[{key:"handleRequest",value:function(e,r){}}]),e}();module.exports=Domain;var ServerUtil=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"getFilesFromDirectory",value:function(e,r,t){var i=function(e,i){return!!(i.isDirectory()&&t&&t.indexOf(path.basename(e))>-1)||!!(i.isFile()&&r&&r.indexOf(path.basename(e))>-1)};return new Promise(function(r,t){recursive(e,[".htaccess",i],function(e,i){r(i),e&&t(e)})})}}]),e}(),doTheThing=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,ServerUtil.getFilesFromDirector("/home/dustin/dev/personal/starkserver/src");case 2:r=e.sent,console.log(r);case 4:case"end":return e.stop()}},e,void 0)}));return function(){return e.apply(this,arguments)}}();doTheThing(),module.exports=ServerUtil;var os=require("os"),fs=require("fs"),path=require("path"),http=require("http"),https=require("https"),HttpDispatcher=require("httpdispatcher"),recursive=require("recursive-readdir"),simpleNodeLogger=require("simple-node-logger"),SERVER_VERSION="1.7.0";https.globalAgent.options.secureProtocol="SSLv3_method";var removeWWW=function(e){return e.indexOf("www")>-1?e.substring(4,e.length):e},removePort=function(e){var r=e.indexOf(":");return r>-1?e.substring(0,r):e},getFileType=function(e){for(var r="",t=e.length-1;t>=0&&"."!=e[t];t--)r+=e[t];return r.split("").reverse().join("")},getFilesFromDirectory=function(e,r,t,i){recursive(e,[".htaccess",function(e,i){return!!(i.isDirectory()&&t.indexOf(path.basename(e))>-1)||!!(i.isFile()&&r.indexOf(path.basename(e))>-1)}],function(e,r){i(r)})},constructURLFromPath=function(e,r){var t=r.indexOf(e.baseDirectory);return t>-1?r.substring(t+e.baseDirectory.length,r.length):""},StarkServer=function(){function e(){var r=this;_classCallCheck(this,e),this.domains=[],this.drivers=[],this.HTTPPort=8080,this.HTTPSPort=8081,this.domainIndexSet={},this.mimeTypeLookup=require("mime-types").lookup,this.logger=simpleNodeLogger.createSimpleLogger({logFilePath:"StarkServer.log",timestampFormat:"YY-MM-DD HH:MM:ss"}),this.handleRequest=function(e,t){try{var i=e.headers.host;i=removeWWW(i),i=removePort(i);for(var n in r.domains)i==r.domains[n].host&&r.domains[n].dispatcher.dispatch(e,t)}catch(e){r.logger.error("Problem handling request: ",e)}},this.HTTPServer=http.createServer(this.handleRequest)}return _createClass(e,[{key:"getServerletiables",value:function(e){var r=this.HTTPSServer?this.HTTPSPort:this.HTTPPort,t=removePort(e.headers.host),i="StarkServer/"+SERVER_VERSION+" ("+os.type()+")",n=i+"Server at "+t+" Port "+r;return{server_software:i,server_name:e.connection.servername,request_method:e.method,query_string:e.url.split("?").length>1?e.url.split("?")[1]:"",http_accept:e.headers.accept,http_accept_encoding:e.headers["accept-encoding"],http_accept_language:e.headers["accept-language"],http_host:t,http_user_agent:e.headers["user-agent"],remote_addr:e.connection.remoteAddress,server_admin:"web@localhost",server_port:r,server_signature:n}}},{key:"checkIfFileExists",value:function(e){try{return fs.statSync(e).isFile()}catch(e){if("ENOENT"===e.code)return!1;throw e}}},{key:"setHTTPPort",value:function(e){this.HTTPPort=e}},{key:"setSSLPort",value:function(e){this.HTTPSPort=e}},{key:"setSSLOptions",value:function(e){if(this.checkIfFileExists(e.cert)&&this.checkIfFileExists(e.key)){var r={cert:fs.readFileSync(e.cert),key:fs.readFileSync(e.key)};this.HTTPSServer=https.createServer(r,this.handleRequest),this.HTTPServer=http.createServer(function(e,r){r.writeHead(302,{Location:"https://"+e.headers.host+e.url}),r.end()})}else this.logger.error("Invalid SSL cert or key file set in configuration.")}},{key:"generateDispatcherRequest",value:function(e,r){var t=this,i=constructURLFromPath(e,r),n=getFileType(r),o=this.mimeTypeLookup(n),s=null,a=null,c=function(e){console.log(e);var r={};try{r=Object.keys(e)[0],r=r.replace(/[\\]+/g,""),r=JSON.parse(r)}catch(t){r=e}return console.log(r),r},l=function(e,r,i){i&&t.logger.error(i),"NOT_SUPPORTED_FILE"==e?fs.readFile(r,function(r,i){r&&t.logger.error(r),a.writeHead(200,{"Content-Type":e}),a.end(i)}):(a.writeHead(200,{"Content-Type":t.mimeTypeLookup(r)}),a.end(r))},h=function(i,c){s=i,a=c;var h=!1;for(var u in t.drivers)if(t.drivers[u].fileTypes.indexOf(n)>-1){var d=require(path.join(__dirname,path.normalize(t.drivers[u].driverFile))),v=t.getServerletiables(i);v.document_root=path.normalize(e.baseDirectory+"/"),h=!0,new d(v).onGet(r,i.params,l)}h||(c.writeHead(200,{"Content-Type":o}),fs.readFile(r,function(e,r){c.end(r)}))},u=function(i,h){var u=!1,d=c(i.params);s=i,a=h;for(var v in t.drivers)if(t.drivers[v].fileTypes.indexOf(n)>-1){var f=require(path.join(__dirname,path.normalize(t.drivers[v].driverFile))),p=t.getServerletiables(i);p.document_root=path.normalize(e.baseDirectory+"/"),u=!0,new f(p).onPost(r,d,l)}u||(h.writeHead(200,{"Content-Type":o}),fs.readFile(r,function(e,r){h.end(r)})),void 0!==e.onPost&&e.onPost(i.params,r)};e.dispatcher.onGet(i,h),e.dispatcher.onPost(i,u),void 0===this.domainIndexSet[e.host]&&(void 0!==e.index?i=="/"+e.index&&(e.dispatcher.onGet("/",h),e.dispatcher.onPost("/",u),this.domainIndexSet[e.host]=!0):i.indexOf("index")>-1&&(e.dispatcher.onGet("/",h),e.dispatcher.onPost("/",u),this.domainIndexSet[e.host]=!0))}},{key:"setupNewDomain",value:function(e){var r=this;e.host=removeWWW(e.host),e.dispatcher=new HttpDispatcher;var t=void 0===e.filesToIgnore?[]:e.filesToIgnore,i=void 0===e.directoriesToIgnore?[]:e.directoriesToIgnore,n=function(t){if(void 0!==t)for(var i=t.length-1;i>=0;i--)if("*"==e.allowedFileTypes||e.allowedFileTypes.indexOf(getFileType(t[i]))>-1){var n=path.normalize(t[i]);r.generateDispatcherRequest(e,n)}};if(getFilesFromDirectory(e.baseDirectory,t,i,n),e.dispatcher.onError(function(t,i){var n=void 0===e.error[404]?"404 - Page does not exist.":e.error[404],o=path.normalize(e.baseDirectory+"/"+n),s=r.checkIfFileExists(o);i.writeHead(404),s?i.end(fs.readFileSync(o)):i.end(n)}),e.secure&&void 0!==e.cert&&void 0!==e.key)if(this.checkIfFileExists(e.cert)&&this.checkIfFileExists(e.key)){var o={key:fs.readFileSync(e.key),cert:fs.readFileSync(e.cert)};this.server=https.createServer(o,this.handleRequest)}else this.logger.warn("Path to SSL certificate or key invalid for domain: "+e.host)}},{key:"addDomain",value:function(e){if(Array.isArray(e.host))for(var r=e.host,t=0;t<r.length;t++){var i={host:r[t],baseDirectory:e.baseDirectory,allowedFileTypes:e.allowedFileTypes,index:e.index,filesToIgnore:e.filesToIgnore,directoriesToIgnore:e.directoriesToIgnore,error:e.error};this.domains.push(i),this.setupNewDomain(i)}else this.domains.push(e),this.setupNewDomain(e)}},{key:"addDomains",value:function(e){for(var r in e)void 0!==r&&this.addDomain(e[r])}},{key:"addDriver",value:function(e){this.drivers.push(e)}},{key:"addDrivers",value:function(e){for(var r in e)void 0!==r&&this.addDriver(e[r])}},{key:"setAllowedFileTypes",value:function(e,r){for(var t=this.domains.length-1;t>=0;t--)if(this.domains[t].host==e){this.domains[t].allowedFileTypes=r;break}}},{key:"startHTTP",value:function(){var e=this;this.HTTPServer.listen(this.HTTPPort,function(){e.logger.info("Listening on: http://localhost:",e.HTTPPort)})}},{key:"startHTTPS",value:function(){var e=this;this.HTTPSServer.listen(this.HTTPSPort,function(){e.logger.info("Listening on: https://localhost:",e.HTTPSPort)})}},{key:"start",value:function(){this.startHTTP(),void 0!==this.HTTPSServer&&this.startHTTPS()}}]),e}();module.exports=new StarkServer;